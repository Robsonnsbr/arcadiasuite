services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: arcadiasuite-app:latest
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      DATABASE_URL: ${DATABASE_URL:-postgresql://arcadia_user:arcadia_pass@db:5432/arcadia_suite}
      PGHOST: ${PGHOST:-db}
      PGPORT: ${PGPORT:-5432}
      PGUSER: ${PGUSER:-arcadia_user}
      PGPASSWORD: ${PGPASSWORD:-arcadia_pass}
      PGDATABASE: ${PGDATABASE:-arcadia_suite}
      SESSION_SECRET: ${SESSION_SECRET:-change-me}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-true}
      DISABLE_AUTH: ${DISABLE_AUTH:-false}
      DEV_OPEN_ACCESS: ${DEV_OPEN_ACCESS:-false}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AI_INTEGRATIONS_OPENAI_API_KEY: ${AI_INTEGRATIONS_OPENAI_API_KEY:-}
      PLUS_AUTO_START: ${PLUS_AUTO_START:-false}
      PLUS_HOST: ${PLUS_HOST:-controlplus.example.com}
      PLUS_PORT: ${PLUS_PORT:-443}
      PLUS_BASE_URL: ${PLUS_BASE_URL:-https://controlplus.example.com}
      METABASE_AUTO_START: ${METABASE_AUTO_START:-false}
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${ARCADIA_HTTP_PORT:-5000}:5000"
    healthcheck:
      test:
        - CMD
        - node
        - -e
        - require('http').get('http://127.0.0.1:5000/api/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 45s
    networks:
      - arcadiasuite

  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-arcadia_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-arcadia_pass}
      POSTGRES_DB: ${POSTGRES_DB:-arcadia_suite}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-arcadia_user} -d ${POSTGRES_DB:-arcadia_suite}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - arcadiasuite

volumes:
  pgdata:

networks:
  arcadiasuite:
